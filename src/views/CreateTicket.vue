<template>
    <div id="template">
        
        <TemplateHeader />
        <div class="container content-small">
            <h1>Neues Ticket erstellen</h1>
            <hr />
            <p>Bitte fülle das Formular möglichst detailliert aus, damit der gefundene Fehler bzw. die vorgeschlagene Verbesserung effizient angenommen und umgesetzt werden kann.</p>
            <p style="font-size:0.8em;">Alle Formularfelder - außer als optional gekennzeichnete - sind Pflichtfelder.</p>
            <p>&nbsp;</p>
            
            <form @submit.prevent="handleSubmit" action="">
                <div class="error mb-4">{{error}}</div>
                
                <div class="mb-4">
                    <label for="issueTitle">Titel (Überschrift):</label>
                    <input type="text" class="form-control" v-model="title"  name="issueTitle" id="issueTitle" maxlength="80" required>
                </div>
                <div class="mb-4">
                    <label for="issueCourse">Kurs:</label>
                    <select name="issueCourse" v-model="course" class="form-select" id="issueCourse" required>
                        <option  value="" disabled>Kurs auswählen</option>
                        <option v-for="item in courseList" :value="item" :key="item.id">
                        {{ item.course }}
                        </option>
                    </select>
                </div>
                <div class="row">
                    <div class="mb-4 col-md-6">
                        <label for="issueIssueType">Kategorie, Art der Meldung:</label>
                        <select name="issueIssueType" v-model="category" class="form-select" id="issueIssueType">
                            <option value="" disabled>Kategorie auswählen</option>
                            <option v-for="item in categoryList" :value="item.categoryText" :key="item.id">
                            {{ item.categoryText }}
                            </option>
                        </select>
                    </div>
                    <div class="mb-4 col-md-6">
                        <label for="issueIssuePrio">Priorität:</label>
                        <select name="issueIssuePrio" v-model="priority" class="form-select" id="issueIssuePrio">
                            <option v-for="item in priorityList" :value="item.priorityTitle" :key="item.id">
                            {{ item.priorityTitle }}
                            </option>
                        </select>
                    </div>
                </div>
                <div class="mb-4" id="mediaList">
                    <p><label>Betroffenen Medien:</label></p>
                    <div class="media-input">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="media[]" v-model="arrLearnApp" id="mediaApp" value="Learn App/IU Reader">
                            <label class="form-check-label" for="mediaApp">Learn App/IU Reader</label>
                        </div>
                        <div class="form-group">
                            <input class="form-control" v-model="arrLearnAppDescription" id="AppPosition" type="text" placeholder="Position eingeben (Seite, Kapitel)" maxlength="40">
                        </div>
                    </div>
                    <div class="media-input">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="media" v-model="arrSkriptPDF" id="mediaPdf" value="Skript-PDF">
                            <label class="form-check-label" for="mediaPdf">Skript <span class="form-text">(PDF)</span></label>
                        </div>
                        <div class="form-group">
                            <input class="form-control" v-model="arrSkriptPDFDescription" type="text" placeholder="Position eingeben (Seite, Kapitel, Version)" maxlength="40">
                        </div>
                    </div>
                    <div class="media-input">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="media"  v-model="arrSkriptDruck" id="mediaPrint" value="Skript-Druck">
                            <label class="form-check-label" for="mediaPrint">Skript <span class="form-text">(Druck)</span></label>
                        </div>
                        <div class="form-group">
                            <input class="form-control" v-model="arrSkriptDruckDescription" type="text" placeholder="Position eingeben (Seite, Kapitel, Version)" maxlength="40">
                        </div>
                    </div>
                    <div class="media-input">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="media" v-model="arrVideo" id="mediaVideo" value="Video">
                            <label class="form-check-label" for="mediaVideo">Video <span class="form-text">(Vodcast, Tutorium)</span></label>
                        </div>
                        <div class="form-group">
                            <input class="form-control" v-model="arrVideoDescription" type="text" placeholder="Position eingeben (Zeit in Minuten, Dateiname)" maxlength="40">
                        </div>
                    </div>
                    <div class="media-input">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="media" v-model="arrAudio" id="mediaAudio" value="Audio">
                            <label class="form-check-label" for="mediaAudio">Audio <span class="form-text">(Podcast)</span></label>
                        </div>
                        <div class="form-group">
                            <input class="form-control" v-model="arrAudioDescription" type="text" placeholder="Position eingeben (Zeit in Minuten, Dateiname)" maxlength="40">
                        </div>
                    </div>
                    <div class="media-input">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="media" v-model="arrOnlineTest" id="mediaTest" value="Online-Test">
                            <label class="form-check-label" for="mediaTest">Online-Test <span class="form-text">(MyCampus)</span></label>
                        </div>
                        <div class="form-group">
                            <input class="form-control" v-model="arrOnlineTestDescription" type="text" placeholder="Position eingeben (Kapitel, Frage-Nr.)" maxlength="40">
                        </div>
                    </div>
                    <div class="media-input">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="media" v-model="arrRepetitorium" id="mediaRepetitorium" value="Repetitorium">
                            <label class="form-check-label" for="mediaRepetitorium">Repetitorium</label>
                        </div>
                        <div class="form-group">
                            <input class="form-control" v-model="arrRepetitoriumDescription" type="text" placeholder="Position eingeben (Frage-Nr., Seite)" maxlength="40">
                        </div>
                    </div>
                    <div class="media-input">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="media" v-model="arrMusterklausur" id="mediaMusterklausur" value="Musterklausur">
                            <label class="form-check-label" for="mediaMusterklausur">Musterklausur</label>
                        </div>
                        <div class="form-group">
                            <input class="form-control" v-model="arrMusterklausurDescription" type="text" placeholder="Position eingeben (Klausur-Nr., Frage-Nr., Seite)" maxlength="40">
                        </div>
                    </div>
                    <div class="media-input">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="media" v-model="arrSonstiges" id="mediaSonstiges" value="Sonstiges">
                            <label class="form-check-label" for="mediaSonstiges">Sonstiges <span class="form-text">(bitte u. ausführen)</span></label>
                        </div>
                        <div class="form-group">
                            <input class="form-control"  v-model="arrSonstigesDescription" type="text" placeholder="Medium und Position eingeben" maxlength="40">
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="issueDescription">Beschreibe deine Ticketmeldung:</label>
                    <textarea required class="form-control" v-model="issueDescription" name="issueDescription" id="issueDescription" style="min-height:200px; max-height:70vh;"></textarea>
                </div>
                <div class="mb-4">
                    <label for="issueFile">Upload von Dateien (optional):</label>
                    <input type="file" class="form-control" @change="handleChange" name="issueFile" id="issueFile" accept="image/png, image/jpeg, .pdf, .docx, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, .mp4">
                    <div class="form-text">Erlaubte Dateiformate: Bilder (jpg, jpeg, png), PDF, MP4-Video und MS Word. <br>Dateigröße: max. 5 MB</div>
                </div>
                <div class="mt-4">
                    <button v-if="!isPending" class="btn btn-lg btn-primary" type="submit">Ticket einreichen</button>
                    <button v-else disabled class="btn btn-lg btn-primary" type="submit">Ticket wird erstellt...</button>
                </div>
            </form>

            <!--  AB HIER TICKET ANSICHT FÜR TUTOR -->
            <div style="background:#000; padding:1em; margin:2em 0; color:#fff; text-align:center;">
                - AB HIER TICKET FORMULAR FÜR TUTOR -
            </div>

            <form action="">
                <div class="mb-4">
                    <label class="view">Titel (Überschrift):</label>
                    <div>Hier steht die Überschrift des Tickets</div>
                </div>
                <div class="mb-4">
                    <label class="view">Kurs:</label>
                    <div>Mathematik 2</div>
                </div>
                <div class="row">
                    <div class="mb-4 col-md-6">
                        <label class="view">Kategorie, Art der Meldung:</label>
                        <div>🟡 Rechtschreibfehler</div>
                    </div>
                    <div class="mb-4 col-md-6">
                        <label class="view">Priorität:</label>
                        <div>Niedrig</div>
                    </div>
                </div>
                <div class="mb-4">
                    <p><label class="view">Betroffenen Medien:</label></p>
                    <ul>
                        <li>
                            <label>Learn App/IU Reader:</label>
                            <div>Blabla hier steht irgend was zur Position</div>
                        </li>
                        <li>
                            <label>Skript:</label>
                            <div>Blabla jhdfskaof jhsdiof ji</div>
                        </li>
                    </ul>
                </div>
                <div class="mb-4">
                    <label class="view">Beschreibe deine Ticketmeldung:</label>
                    <div>Hallo,<br>ich habe alles gefunden um euch einen Fehler zu melden....<br>MfG</div>
                </div>
                <div class="mb-4">
                    <label class="view">Dateien:</label>
                    <div><i>Keine vorhanden.</i></div>
                </div>

                <hr>
                <h3>Bearbeitung durch Tutor</h3>

                <div class="mb-4">
                    <label for="feedbackComment">Tutor-Feedback:</label>
                    <textarea class="form-control" name="feedbackComment" id="feedbackComment" style="min-height:100px;"></textarea>
                </div>
                <div class="mt-4">
                    Status ändern:
                </div>
                <div class="mt-1">
                    <button type="button" class="btn btn-warning">In Arbeit</button> &nbsp; 
                    <button type="button" class="btn btn-success">Erledigt</button> &nbsp; 
                    <button type="button" class="btn btn-info">Abgelehnt</button>
                </div>
                <hr>
            </form>
            
        </div>
        
        <TemplateFooter />
    </div>
</template>

<script>
import TemplateHeader from "../components/TemplateHeader.vue";
import TemplateFooter from "../components/TemplateFooter.vue";
import { ref } from "@vue/reactivity";
import { useRouter } from "vue-router";
import getUser from "../composables/getUser";
import useStorage from "../composables/useStorage";
import useCollection from "../composables/useCollection";
import { timestamp } from "../firebase/config";
import tutor_course from "../assets/tutor_course.json";
import ticket_category from "../assets/ticket_category.json";
import ticket_priority from "../assets/ticket_priority.json";

export default {
    components: {
        TemplateHeader,
        TemplateFooter,
       
    },
    mounted() {
        document.querySelector("#mainmenu li a").classList.remove("active");
        document
            .getElementById("navbarDropdownAccount")
            .classList.add("active");
        let items = document.querySelectorAll("#mediaList .media-input");
        for (let i = 0; i < items.length; i++) {
            let checkbox = items[i].querySelector("input[type=checkbox]");
            let inputDiv = items[i].querySelector(".form-group");
            let input = items[i].querySelector(".form-group input[type=text]");
            checkbox.addEventListener("click", function () {
                if (this.checked) {
                    inputDiv.style.display = "block";
                    input.focus();
                } else {
                    inputDiv.style.display = "none";
                }
            });
        }
    },
    data() {
        return {
            courseList: tutor_course,
            categoryList: ticket_category,
            priorityList: ticket_priority,
        };
    },
    setup(props, context) {
        const { filePath, url, uploadFile } = useStorage();
        const { error, addDoc } = useCollection("tickets");
        const { user } = getUser();
        // Referenzen für die eingaben
        const title = ref(null);
        const course = ref(null);
        const category = ref(null);
        const priority = ref('Niedrig');

       
       
        let arrLearnApp = ref([]);
        const arrLearnAppDescription = ref('');

        let arrSkriptPDF = ref([]);
        const arrSkriptPDFDescription = ref('');

        let arrSkriptDruck = ref([]);
        const arrSkriptDruckDescription = ref('');
        let arrVideo = ref([]);
        const arrVideoDescription = ref('');

        let arrAudio = ref([]);
         const arrAudioDescription = ref('');

        let arrOnlineTest = ref([]);
        const arrOnlineTestDescription = ref('');

        let arrRepetitorium = ref([]);
        const arrRepetitoriumDescription = ref('');

        let arrMusterklausur = ref([]);
        const arrMusterklausurDescription = ref('');

        let arrSonstiges = ref([]);
        const arrSonstigesDescription = ref('');


        const issueDescription = ref("");
        const file = ref(null);
        const fileError = ref(null);
        const isPending = ref(false);
        const status = ref("Offen");
        const getTutor = (val) => {
            return val;
        };
        const handleSubmit = async () => {
            if (file.value) {
                isPending.value = true;
                await uploadFile(file.value);
                await addDoc({
                    title: title.value,
                    courseInformation: course.value,
                    category: category.value,
                    priority: priority.value,                    
                    LearnApp_Fehler: [...arrLearnApp.value, arrLearnAppDescription.value],
                    PDF_Skript_Fehler: [...arrSkriptPDF.value,arrSkriptPDFDescription.value],
                    Druckskript_Fehler: [...arrSkriptDruck.value,arrSkriptDruckDescription.value], 
                    Video_Fehler: [...arrVideo.value, arrVideoDescription.value],
                    Audio_Fehler: [...arrAudio.value, arrAudioDescription.value],
                    OnlineTest_Fehler: [...arrOnlineTest.value,arrOnlineTestDescription.value],
                    Repetitorium_Fehler: [...arrRepetitorium.value,arrRepetitoriumDescription.value],
                    Musterklausur_Fehler: [...arrMusterklausur.value,arrMusterklausurDescription.value],
                    Sonstige_Fehler: [...arrSonstiges.value, arrSonstigesDescription.value],
                    description: issueDescription.value,
                    priority: priority.value,
                    author: user.value.uid,
                    authorName: user.value.displayName,
                    authorMail: user.value.email,
                    fileUrl: url.value,
                    status: status.value,
                    filePath: filePath.value,
                    createdAt: timestamp(),
                });
                isPending.value = false;
                if (!error.value) {
                    console.log("ticket added");
                }
            }
        };
        const types = ["image/png", "image/jpeg", "application/pdf", "video/mp4"];
        const handleChange = (e) => {
            const selected = e.target.files[0];
            console.log(selected);
           
            if (selected && types.includes(selected.type)) {
                console.log("hallo Change");
                file.value = selected;
                fileError.value = null;
            }
        };
        return {
            title,
            course,
            category,
            priority,           
            arrLearnApp,
            arrLearnAppDescription,
            arrSkriptPDF,
            arrSkriptPDFDescription,
            arrSkriptDruck,
            arrSkriptDruckDescription,
            arrVideo,
            arrVideoDescription,
            arrAudio,
            arrAudioDescription,
            arrOnlineTest,
            arrOnlineTestDescription,
            arrRepetitorium,
            arrRepetitoriumDescription,
            arrMusterklausur,
            arrMusterklausurDescription,
            issueDescription,
            arrSonstiges,
            fileError,
            handleSubmit,
            handleChange,
            isPending,
            getTutor,
        };
    },
};
</script>

<style>
#mediaList .media-input {
    margin-bottom:5px;
}
#mediaList .media-input::before,
#mediaList .media-input::after {
    content: " ";
    display: table;
}
#mediaList .media-input:after {
    clear: both;
}
#mediaList .form-check {
    display:block;
    padding-top:6px;
    padding-bottom:6px;
    float:left;
}
#mediaList .form-group {
    margin-left:40%;
    display:none;
}
@media screen and (max-width: 767px) {
    #mediaList .form-group {
        margin-left:0;
    }
}

label.view {
    color:#999;
}

</style>